trigger:
  branches:
    include:
      - main

variables:
  registry: 'quay.io/ronybane'
  imageName: 'api-notificaciones-whatsapp'
  tag: 'latest'

stages:
- stage: BuildAndPush
  displayName: 'Construir y subir imagen'
  jobs:
  - job: BuildAndPushJob
    displayName: 'Construir y subir imagen Docker'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: CmdLine@2
      displayName: 'Login al registry'
      inputs:
        script: |
          echo "Iniciando login al registry..."
          echo "$(registryPassword)" | podman login -u "$(registryUser)" --password-stdin "$(registry)"
          if [ $? -ne 0 ]; then
            echo "Error en login, abortando."
            exit 1
          fi
      env:
        registryUser: $(registryUser)
        registryPassword: $(registryPassword)

    - task: CmdLine@2
      displayName: 'Construir la imagen con Podman'
      inputs:
        script: |
          echo "Construyendo la imagen..."
          podman build -t "$(registry)/$(imageName):$(tag)" .

    - task: CmdLine@2
      displayName: 'Subir la imagen a registry'
      inputs:
        script: |
          echo "Subiendo la imagen..."
          podman push "$(registry)/$(imageName):$(tag)"

- stage: Deploy
  displayName: 'Desplegar en OpenShift'
  dependsOn: BuildAndPush
  jobs:
  - job: DeployJob
    displayName: 'Desplegar en OpenShift'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: CmdLine@2
      displayName: 'Login en OpenShift'
      inputs:
        script: |
          echo "Iniciando login en OpenShift..."
          oc login --token=$(ocToken) --server=$(ocServer)

          echo "Actualizando despliegue..."
          oc set image deployment/tu-deployment tu-container=$(registry)/$(imageName):$(tag)

          echo "Verificando rollout..."
          oc rollout status deployment/tu-deployment